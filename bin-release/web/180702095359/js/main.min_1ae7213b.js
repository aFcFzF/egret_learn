var __reflect=this&&this.__reflect||function(t,e,r){t.__class__=e,r?r.push(e):r=[e],t.__types__=t.__types__?r.concat(t.__types__):r},__extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);r.prototype=e.prototype,t.prototype=new r},__awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(n,s){function a(t){try{h(i.next(t))}catch(e){s(e)}}function o(t){try{h(i["throw"](t))}catch(e){s(e)}}function h(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(a,o)}h((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function r(t){return function(e){return i([t,e])}}function i(r){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,s&&(a=s[2&r[0]?"return":r[0]?"throw":"next"])&&!(a=a.call(s,r[1])).done)return a;switch(s=0,a&&(r=[0,a.value]),r[0]){case 0:case 1:a=r;break;case 4:return h.label++,{value:r[1],done:!1};case 5:h.label++,s=r[1],r=[0];continue;case 7:r=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===r[0]||2===r[0])){h=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){h.label=r[1];break}if(6===r[0]&&h.label<a[1]){h.label=a[1],a=r;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(r);break}a[2]&&h.ops.pop(),h.trys.pop();continue}r=e.call(t,h)}catch(i){r=[6,i],s=0}finally{n=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var n,s,a,o,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:r(0),"throw":r(1),"return":r(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o},LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.$textPos=0,e.$bg=null,e.$playground=null,e.$pgr=null,e.$gameTiles=[],e.$gameTileSprs=[],e.$gameTileShps=[],e.$gmTilesShp=null,e.$vertCount=0,e.$per=0,e.$horzCount=10,e.$baseX=0,e.$baseY=0,e.$tShapes=null,e.$gmFont=null,e.$previewBox={container:null,previewItems:[],tetQueue:null,previewItemShps:[],rowCount:4,previewItemY:[]},e.$tetromino={"char":"",hNum:0,vNum:0,spr:null,tetData:[],tetTiles:[],realPos:[],count:0,idx:0,hasPressKey:0},e.$particleEffect={txrs:[],partBox:null,partSys:null,task:[]},e.$ctrlBtns={38:{sprName:"rotate",spr:null,bg:"rotate",start:!1,proc:null,tap:null,sound:"rotation_mp3"},40:{sprName:"down",spr:null,bg:"down",bitmap:null,start:!1,proc:null,tap:null,sound:"down_mp3"},88:{sprName:"hardDown",spr:null,bg:"hard_down",bitmap:null,start:!1,proc:null,tap:null,sound:"fastDown_mp3"},37:{sprName:"left",spr:null,bg:"left",start:!1,proc:null,tap:null,sound:"action_mp3"},39:{sprName:"right",spr:null,bg:"right",bitmap:null,start:!1,proc:null,tap:null,sound:"action_mp3"}},e.i=0,e.interval=0,e.tms=0,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.init,e),e}return __extends(e,t),e.prototype.init=function(){var t=this;this.stage.scaleMode=egret.StageScaleMode.NO_SCALE,this.stage.addEventListener(egret.Event.RESIZE,this.paint,this),window.addEventListener("keydown",function(e){return t.keyDownHandler(e.keyCode)}),window.addEventListener("keyup",function(e){return t.keyUpHandler(e.keyCode)});var e=function(){RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,e,t),console.log("载入ui"),t.initUi(),t.initLogic()},r=function(){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,r,t),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,e,t),RES.loadGroup("preload")};RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,r,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.paint=function(){var t=this,e=this.$stage.$stageWidth,r=this.$stage.$stageHeight;Object.assign(this.$bg,{width:e,height:r});var i=e-120,n=r-160,s=this.$horzCount,a=this.$per=~~(i/s),o=~~(n/a);this.$vertCount=o=o>20?20:o,i=a*s,n=o*a,console.log("宽和高： ",i,n),Object.assign(this.$playground,{x:10,y:70,width:i,height:n}),this.$pgr.clear(),this.$baseX=~~(this.$horzCount/2-2),this.$baseY=0,this.$tetromino.spr.y=0,this.$tetromino.spr.x=~~(this.$horzCount/2-2)*this.$per;for(var h=0;o>h;h++){for(var l=0;s>l;l++)this.$pgr.lineStyle(0),(l+h)%2===0?this.$pgr.beginFill(4012094,1):this.$pgr.beginFill(4866904,1),this.$pgr.drawRoundRect(l*a,h*a,a,a,3),this.$pgr.endFill(),h===o-1&&(this.$pgr.lineStyle(2,0,.2,!1,"","","",0,[5]),this.$pgr.moveTo(a*(l+1),0),this.$pgr.lineTo(a*(l+1),n));this.$pgr.lineStyle(2,0,.2,!1,"","","",0,[5]),this.$pgr.moveTo(0,a*(h+1)),this.$pgr.lineTo(i,a*(h+1))}this.$pgr.beginFill(0,.3),this.$pgr.lineStyle(3,16777215,.8),this.$pgr.drawRoundRect(-2,-2,i+3,n+3,4),this.$pgr.lineStyle(1,16777215,.2),this.$pgr.endFill();var c=this.$previewBox,p=c.container,u=c.previewItems,g=c.rowCount,d=90,f=270;Object.assign(p,{x:i+20,y:70,width:d,height:f});var m=p.$graphics;m.clear(),m.lineStyle(3,16777215,.8),m.beginFill(0,.4),m.drawRoundRect(-2,-2,d+3,f+3,4),m.endFill(),u.forEach(function(e,r){e.x=10,t.$previewBox.previewItemY[r]=e.y=20+10*(r+1)+70*r;var i=e.$graphics;i.clear(),i.lineStyle(0),i.drawRoundRect(0,0,70,70,3);var n=~~(70/g),s=Array.from({length:4},function(t,r){var i=Array.from({length:4},function(t,i){var s=new egret.Shape;return s.width=s.height=n,s.x=r*n,s.y=i*n,e.addChild(s),s});return i});t.$previewBox.previewItemShps.push(s)}),Object.assign(this.$gmTilesShp,{width:i,height:n,name:"gmTilesShp"});var v=this.getChildByName("btnGroup");v.width=e-20;var $=~~((v.width-320)/5);v.height=160+$,v.x=10,v.y=~~(n+70+(r-70-n)/2)-~~(3*(v.height-$)/4)-10;["37","39","38","40"].forEach(function(e,r){console.log("距离",($+80)*r),t.$ctrlBtns[e].spr.x=($+80)*r,t.$ctrlBtns[e].spr.y=$+80}),this.$ctrlBtns[88].spr.x=v.width-80,this.$ctrlBtns[88].spr.y=0},e.prototype.drawTile=function(t,e,r,i,n){t.clear();var s=this.$per;n=n||1,t.beginFill(e),t.drawRect(0,0,s*n,s*n),t.beginFill(i);var a=~~(s*n*.5);t.drawCircle(a+2,a+2,s*n*.3),t.beginFill(r),t.drawCircle(a,a,s*n*.3),t.endFill()},e.prototype.drawTetromino=function(t,e){var r=this,i=this.$tShapes[t],n=this.$per,s=i.color,a=s.bg,o=s.shw,h=s.cre,l=i.shape[e],c=this.$tetromino;Object.assign(c,{"char":t,idx:e,tetData:l,count:i.shape.length});var p={hNum:[l[0][0],l[1][0]],vNum:[l[0][1],l[1][1]]};l.forEach(function(t){t[0]<p.hNum[0]&&(p.hNum[0]=t[0]),t[0]>p.hNum[1]&&(p.hNum[1]=t[0]),t[1]<p.vNum[0]&&(p.vNum[0]=t[1]),t[1]>p.vNum[1]&&(p.vNum[1]=t[1])}),c.hNum=p.hNum[1]-p.hNum[0]+1,c.vNum=p.vNum[1]-p.vNum[0]+1,c.spr.width=c.hNum*n,c.spr.height=c.vNum*n,l.forEach(function(t,e){var i=t[0],n=t[1],s=r.$per,l=c.tetTiles[e];l.name=i+"_"+n,l.x=i*s,l.y=n*s;var p=c.tetTiles[e].$graphics;r.drawTile(p,a,h,o)}),console.log("interface: ",c)},e.prototype.initUi=function(){var t=this,e=this.$bg=new egret.Bitmap,r=RES.getRes("bg_jpg"),i=this.$stage.$stageWidth,n=this.$stage.$stageHeight;e.name="gamebg",e.width=i,e.height=n,e.texture=r,e.fillMode=egret.BitmapFillMode.CLIP,this.addChild(e),this.$gmFont=RES.getRes("gameFont_fnt");var s=this.$playground=new egret.Sprite;this.$pgr=this.$playground.$graphics;s.name="playground",this.addChild(s);var a=this.$gmTilesShp=new egret.Shape;s.addChild(a);var o=this.$previewBox.container=new egret.Sprite;o.name="previewBox",Array.from({length:3},function(e,r){var i=new egret.Sprite;i.name="previewItem_"+r,o.addChild(i),t.$previewBox.previewItems.push(i)}),this.addChild(o);var h=this.$tetromino.spr=new egret.Sprite;h.name="tetromino";for(var l=4;l--;){var c=new egret.Shape;this.$tetromino.tetTiles.push(c),h.addChild(c)}this.$playground.addChild(h);var p=new egret.Sprite;p.name="btnGroup",Object.keys(this.$ctrlBtns).forEach(function(e){var r=t.$ctrlBtns[e];r.spr=new egret.Sprite,r.spr.name=r.sprName,r.bitmap=new egret.Bitmap(RES.getRes(r.bg+"_png")),r.bitmap.fillMode=egret.BitmapFillMode.SCALE,r.spr.width=r.bitmap.width=~~(n/8),r.spr.height=r.bitmap.height=~~(n/8),r.spr.touchEnabled=!0,r.spr.addEventListener(egret.TouchEvent.TOUCH_BEGIN,t.keyDownHandler.bind(t,+e),t),r.spr.addEventListener(egret.TouchEvent.TOUCH_END,t.keyUpHandler.bind(t,+e),t),r.spr.addChild(r.bitmap),p.addChild(r.spr)}),this.addChild(p),this.paint()},e.prototype.initLogic=function(){var t=this,e=this.$horzCount,r=this.$vertCount,i=new egret.Sprite;i.name="gmTileSpr";this.$gameTiles=Array.from({length:r},function(r,n){var s=new egret.Sprite,a=[];return s.name="row-"+n,s.x=s.y=0,t.$gameTileShps.push(a),t.$gameTileSprs.push(i),i.addChild(s),Array.from({length:e},function(e,r){var i=new egret.Shape;return i.name=n+"-"+r,i.width=i.height=t.$per,i.x=r*t.$per,i.y=n*t.$per,a.push(i),s.addChild(i),null})});this.$playground.addChild(i);var n=this.$tShapes=RES.getRes("preDefine_json"),s=Object.keys(n),a=this.$previewBox.tetQueue={_list:[],dequeue:function(){return this.enqueue(),this._list.shift()},enqueue:function(){var t=s[~~(Math.random()*s.length)],e=n[t].shape.length,r=~~(Math.random()*e);this._list.push([t,r])},size:function(){return this._list.length},list:function(){return this._list}};Array.from({length:10},function(t){return a.enqueue()}),this.updatePreview();var o=new egret.BitmapText;o.font=this.$gmFont,o.x=5,o.y=5,o.scaleX=o.scaleY=.3,o.text="NEXT",this.$previewBox.container.addChild(o);var h=this.$particleEffect.partBox=new egret.Sprite;h.name="partBox";var l=this.$per*this.$horzCount;Object.assign(h,{x:0,y:0,width:l});for(var c=[],p=0;3>p;p++){var u=RES.getRes("level"+p+"_png");c.push(u)}this.$particleEffect.txrs=c;var g=RES.getRes("newParticle_json"),d=this.$particleEffect.partSys=new particle.GravityParticleSystem(c[0],g);Object.assign(d,{x:0,y:0,emitterXVariance:l,cacheAsBitmap:!0}),h.addChild(d),this.$playground.addChild(h);var f=this.$strategy=new TetStrategy(this),m=new egret.BitmapText;Object.assign(m,{font:this.$gmFont,text:"03",scaleX:.6,scaleY:.6});var v=~~(this.$playground.width/2)-~~(.6*m.width/2),$=~~(this.$playground.height/2)-~~(m.height/2);RES.getRes("321_mp3").play(0,1),Object.assign(m,{x:v,y:$-100,alpha:0}),this.$playground.addChild(m),egret.Tween.get(m).to({alpha:1,y:$},800,egret.Ease.bounceOut).call(function(){m.text="02"},this).to({x:v,y:$-100,alpha:0},0).to({alpha:1,y:$},800,egret.Ease.bounceOut).call(function(){m.text="01"},this).to({x:v,y:$-100,alpha:0},0).to({alpha:1,y:$},800,egret.Ease.bounceOut).call(function(){m.text="GO!",v=~~(t.$playground.width/2)-~~(.6*m.width/2)},this).to({x:v,y:$-100,alpha:0},0).to({alpha:1,y:$},800,egret.Ease.bounceOut).call(function(){f.start()},this).to({alpha:0},100)},e.prototype.updatePreview=function(){var t=this,e=this.$previewBox,r=e.tetQueue,i=e.previewItemShps,n=e.rowCount;this.$previewBox.previewItems.forEach(function(e,s){var a=r.list(),o=a[s],h=o[0],l=o[1],c=t.$tShapes[h],p=c.shape,u=c.color,g=p[l],d=u.bg,f=u.cre,m=u.shw,v=+(70/n).toFixed(2),$=t.calcWH(g),y=$.hNum,w=$.vNum;e.x=+((70-y*v)/2).toFixed(2)+10,e.y=+((70-w*v)/2).toFixed(2)+t.$previewBox.previewItemY[s],i[s].forEach(function(t){return t.forEach(function(t){return t.$graphics.clear()})}),g.forEach(function(e,r){var n=e[0],a=e[1],o=i[s][n][a].$graphics,h=(v/t.$per).toFixed(2);t.drawTile(o,d,f,m,+h)})})},e.prototype.isBorder=function(t){var e=this,r=e.$baseX,i=e.$baseY,n=e.$gameTiles,s=e.$tetromino,a=s.realPos=s.tetData.map(function(t){return[t[0]+r,t[1]+i]}),o=this.$tetromino,h=o.hNum;o.vNum;if(t){if(0>=r)return!0;var l={},c=[],p=!1;return a.forEach(function(t){var e=t.slice(),r=e[0],i=e[1];l[i]?l[i][0]>r&&(l[i][0]=r):l[i]=t.slice()}),Object.keys(l).forEach(function(t){return c.push(l[t].slice())}),c.some(function(t){return n[t[1]][t[0]-1]&&(p=!0)}),p}if(h+r>=this.$horzCount)return!0;var u={},g=[],d=!1;return a.forEach(function(t){var e=t.slice(),r=e[0],i=e[1];u[i]?u[i][0]<r&&(u[i][0]=r):u[i]=t.slice()}),Object.keys(u).forEach(function(t){return g.push(u[t].slice())}),g.some(function(t){return n[t[1]][t[0]+1]&&(d=!0)}),d},e.prototype.rotate=function(){var t=(this.$tetromino.idx+1)%this.$tetromino.count,e=this.$tetromino["char"],r=this.$tShapes[e].shape[t],i=this.checkRotate(r);i&&this.drawTetromino(this.$tetromino["char"],t)},e.prototype.moveLeft=function(t){return!t&&this.isBorder(!0)?null:(this.$baseX--,void(this.$tetromino.spr.x-=this.$per))},e.prototype.moveRight=function(){return this.isBorder(!1)?null:(this.$baseX++,void(this.$tetromino.spr.x+=this.$per))},e.prototype.moveUp=function(){this.$baseY--,this.$tetromino.spr.y-=this.$per},e.prototype.down=function(){var t=this.checkPos();t?(console.info("可以update了"),this.update()):(this.$baseY++,this.$tetromino.spr.y+=this.$per)},e.prototype.checkPos=function(){var t=this,e=this,r=e.$baseX,i=e.$baseY,n=(e.$vertCount,e.$gameTiles),s=e.$tetromino,a=s.realPos=s.tetData.map(function(t){return[t[0]+r,t[1]+i]}),o=s.vNum,h={},l=[];a.forEach(function(t){var e=t.slice(),r=e[0],i=e[1];h[r]?h[r][1]<i&&(h[r][1]=i):h[r]=t.slice()}),Object.keys(h).forEach(function(t){return l.push(h[t].slice())});var c=!1;return l.some(function(e){return i+o>=t.$vertCount&&(c=!0),!c&&n[e[1]+1][e[0]]&&(c=!0),c}),c},e.prototype.update=function(){var t=this,e=this,r=e.$tetromino,i=e.$gameTiles;r.realPos.forEach(function(t){i[t[1]][t[0]]="te-"+r["char"]}),this.cleanUp(),this.$gameTiles.forEach(function(e,r){return e.forEach(function(e,i){if(null===e)return void t.$gameTileShps[r][i].$graphics.clear();var n=e.split("-")[1],s=t.$tShapes[n].color,a=s.bg,o=s.cre,h=s.shw;t.drawTile(t.$gameTileShps[r][i].$graphics,a,o,h)})}),this.$baseX=~~(this.$horzCount/2),this.$baseY=0,r.spr.y=0,r.spr.x=~~(this.$horzCount/2)*this.$per;var n=this.$previewBox.tetQueue.dequeue();this.drawTetromino(n[0],n[1]),this.updatePreview()},e.prototype.cleanUp=function(){var t=this,e=this,r=e.$gameTiles,i=(e.$gameTileShps,e.$tShapes,e.$gameTileSprs,e.$particleEffect),n=e.$per,s=e.$horzCount,a=(e.$strategy,[]),o=[],h=[];r.forEach(function(t,e){-1===t.indexOf(null)&&(a[e]=e)}),a.filter(function(t){return"number"==typeof t&&t>=0}).forEach(function(t){void 0===h[0]&&(h=[t,t]),t-h[1]===1&&(h[1]=t),t-h[1]>1&&(o.push(h),h=[t,t])}),h.length>0&&o.push(h),o.length>0&&(c=i.task).push.apply(c,JSON.parse(JSON.stringify(o)));var l=function(e){var r=e[0],a=e[1]-e[0]+1,o=a>3?2:a>1?1:0,h=a*n;Object.assign(i.partBox,{x:0,y:r*n+10}),Object.assign(i.partSys,{width:s*n,emitAngleVariance:h,texture:i.txrs[o]}),t.$strategy.addScore(a),i.partSys.start(),egret.setTimeout(function(){t.$particleEffect.partSys.stop(),t.$particleEffect.task.length&&l(t.$particleEffect.task.shift())},t,60)};i.task.length&&l(i.task.shift()),o.forEach(function(t){var e=t[0],i=t[1]-t[0]+1;r.splice(e,i);var n=Array.from({length:i},function(t){return Array.from({length:s},function(t){return null})});r.unshift.apply(r,n)});var c},e.prototype.calcWH=function(t){var e={hNum:[t[0][0],t[1][0]],vNum:[t[0][1],t[1][1]]};t.forEach(function(t){t[0]<e.hNum[0]&&(e.hNum[0]=t[0]),t[0]>e.hNum[1]&&(e.hNum[1]=t[0]),t[1]<e.vNum[0]&&(e.vNum[0]=t[1]),t[1]>e.vNum[1]&&(e.vNum[1]=t[1])});var r=e.hNum[1]-e.hNum[0]+1,i=e.vNum[1]-e.vNum[0]+1;return{hNum:r,vNum:i}},e.prototype.checkRotate=function(t){var e=this,r=this,i=r.$horzCount,n=r.$gameTiles,s=r.$tetromino,a=this.calcWH(t),o=a.hNum,h=a.vNum,l=function(t,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var s=!0,a=h+e.$baseY-i>e.$vertCount;return a?s=!1:t.some(function(t){return n[t[1]-i+e.$baseY][t[0]-r+e.$baseX]&&(s=!1),!s}),s},c=this.$baseX+o-i,p=c>0?c:0,u=l(t,p);u&&c>0&&Array.from({length:c},function(t){return e.moveLeft(!0)});var g=0;if(!u){for(var d="i"===s["char"]?3:2,f=1;d>=f;f++)if(l(t,p,f)===!0){g=f,u=!0;break}u&&g>0&&Array.from({length:g},function(t){return e.moveUp()}),u&&c>0&&Array.from({length:p},function(t){return e.moveLeft(!0)})}return u},e.prototype.repeatProc=function(t){return this.interval++%2===0&&t.call(this),this.interval>1e5&&(this.interval=0),!0},e.prototype.hasRepeat=function(t){return!!this.$ctrlBtns[t].start},e.prototype.startRepeatProc=function(t,e){var r=this;return this.$ctrlBtns[t].start?null:((37===t||39===t)&&this.$tetromino.hasPressKey!==t&&this.$ctrlBtns[this.$tetromino.hasPressKey]&&this.$ctrlBtns[this.$tetromino.hasPressKey].start&&this.stopRepeatProc(this.$tetromino.hasPressKey),e.call(this),void(this.$ctrlBtns[t].tap=egret.setTimeout(function(){if(r.$ctrlBtns[t].tap){r.$ctrlBtns[t].proc=e.bind(r);var i={38:300,40:20,37:20,39:20};r.$ctrlBtns[t].start=egret.setInterval(function(){r.$ctrlBtns[t].start&&e.call(r);var i=RES.getRes(r.$ctrlBtns[t].sound),n=i.play(0,1);40===t&&(n.volume=.2)},r,i[t]),(37===t||39===t)&&(r.$tetromino.hasPressKey=t)}},this,80)))},e.prototype.stopRepeatProc=function(t){return this.$ctrlBtns[t]&&egret.clearTimeout(this.$ctrlBtns[t].tap),this.$ctrlBtns[t]&&(this.$ctrlBtns[t].tap=null),this.hasRepeat(t)?(this.$ctrlBtns[t].start&&egret.clearInterval(this.$ctrlBtns[t].start),void(this.$ctrlBtns[t].start=!1)):null},e.prototype.createText=function(t){var e=new egret.TextField;e.x=0,e.y=this.$textPos,this.$textPos+=20,e.text="按下"+t,e.size=14,this.$playground.addChild(e)},e.prototype.keyDownHandler=function(t){this.$ctrlBtns[t].bitmap.texture=RES.getRes(this.$ctrlBtns[t].bg+"_press_png");var e=RES.getRes(this.$ctrlBtns[t].sound);switch(e.play(0,1),t){case 38:this.startRepeatProc(t,this.rotate);break;case 32:break;case 37:this.startRepeatProc(t,this.moveLeft);break;case 39:this.startRepeatProc(t,this.moveRight);break;case 40:this.startRepeatProc(t,this.down)}},e.prototype.keyUpHandler=function(t){this.$ctrlBtns[t].bitmap.texture=RES.getRes(this.$ctrlBtns[t].bg+"_png"),this.stopRepeatProc(t)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var TetStrategy=function(){function t(t){this.main=null,this.tetScore={score:0,panel:null,fontScore:null,scoreMaxWdt:110,scoreMaxHgt:30,cleanUpText:null},this.tetProgress={level:0,progressBar:null,maxProgress:100,progressShp:null,progressText:null,progress:0,count:0},this.sound={clean1:null,clean2:null,clean3:null,clean4:null},this.pause={pauseBmp:null,pause:!1},this.timer={interval:800},this.init(t)}return t.prototype.init=function(t){var e=this,r=e.tetScore,i=e.tetProgress,n=e.pause,s=e.sound;this.main=t;var a=r.panel=new egret.Sprite;a.name="strategyPanel",Object.assign(a,{x:0,y:0,height:70,width:t.$stage.width}),t.addChild(a);var o=new egret.Sprite,h=new egret.Sprite,l=[r.scoreMaxWdt,r.scoreMaxHgt],c=l[0],p=l[1];Object.assign(o,{name:"scoreBox",x:10,y:20,height:p,width:c});var u=r.cleanUpText=new egret.BitmapText;Object.assign(u,{font:t.$gmFont,scaleX:.2,scaleY:.3,text:"00",x:-3,y:5}),Object.assign(h,{name:"scoreTextArea",x:30,y:0,width:c-15,height:p}),o.addChild(h);var g=o.$graphics;g.beginFill(6247559,.9),g.drawRoundRect(15,0,c,p,8),g.endFill();var d=new egret.Bitmap(RES.getRes("score_png"));Object.assign(d,{x:-10,y:-5,width:40,height:40});var f=r.fontScore=new egret.BitmapText;Object.assign(f,{font:t.$gmFont,x:10,y:5,scaleX:.3,scaleY:.3,text:"0"}),o.addChild(d),h.addChild(f),o.addChild(u),a.addChild(o),this.justifyFont();var m=i.progressBar=new egret.Sprite;Object.assign(m,{name:"progressBar",x:160,y:20,width:i.maxProgress,height:30});var v=m.$graphics;v.beginFill(6247559,.9),v.drawRoundRect(0,0,i.maxProgress,30,8),v.endFill(),a.addChild(m);var $=new egret.Bitmap(RES.getRes("level_png"));Object.assign($,{name:"progIcon",x:-15,y:-5,width:40,height:40});var y=i.progressText=new egret.BitmapText;Object.assign(y,{font:t.$gmFont,scaleX:.2,scaleY:.3,text:"00",x:-8,y:5});var w=i.progressShp=new egret.Shape;Object.assign(w,{x:0,y:0,height:30,width:0}),m.addChild(w),m.addChild($),m.addChild(y);var x=RES.getRes("pause_png"),S=RES.getRes("resume_png"),b=n.pauseBmp=new egret.Bitmap(RES.getRes("pause_png"));Object.assign(b,{x:t.stage.width-34,y:34,width:48,height:48,anchorOffsetX:24,anchorOffsetY:24,touchEnabled:!0}),b.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){n.pause=!n.pause,n.pause?b.texture=S:b.texture=x,egret.Tween.get(b).to({scaleX:.8,scaleY:.8},100).to({scaleX:1,scaleY:1})},this),a.addChild(b),Object.assign(s,{clean1:RES.getRes("delete1_mp3"),clean2:RES.getRes("delete2_mp3"),clean3:RES.getRes("delete3_mp3"),clean4:RES.getRes("delete4_mp3")})},t.prototype.start=function(){var t=this,e=t.main,r=t.timer,i=RES.getRes("gameBG_mp3").play(0,1);i.volume=.3;var n=e.$previewBox.tetQueue.dequeue();console.log("初始化方块",n),e.$tetromino.tetTiles.forEach(function(t){return t.width=t.height=e.$per}),e.drawTetromino(n[0],n[1]),egret.setInterval(e.down,e,r.interval)},t.prototype.justifyFont=function(){var t=this.tetScore,e=[t.scoreMaxWdt,t.scoreMaxHgt],r=e[0],i=e[1],n=[t.fontScore.width,t.fontScore.height],s=n[0],a=n[1],o=s-r>20?+((r-20)/s).toFixed(2):1,h=a-i>10?+((i-10)/a).toFixed(2):1,l=Math.min(o,h);t.fontScore.scaleX=t.fontScore.scaleY=l,t.fontScore.x=~~((r-20)/2)-~~(s*l/2),t.fontScore.y=~~(i/2)-~~(a*l/2)},t.prototype.addScore=function(t){var e=this,r=e.tetScore,i=e.sound;switch(t){case 1:r.score+=10,i.clean1.play(0,1);break;case 2:r.score+=30,i.clean2.play(0,1);break;case 3:r.score+=50,i.clean3.play(0,1);break;case 4:r.score+=80,i.clean4.play(0,1)}this.addProgress(t),this.updateScore()},t.prototype.updateScore=function(){var t=this.tetScore;t.fontScore.text=t.score.toString(),this.justifyFont()},t.prototype.addProgress=function(t){var e=this,r=e.tetProgress,i=e.tetScore,n=~~(r.maxProgress/25),s=r.progressShp.$graphics;if(r.count+=t,i.cleanUpText.text=r.count>9?r.count+"":"0"+r.count,!(r.count%25)){var a=++r.level,o=a>9?a+"":"0"+a;r.progressText.text=o,s.clear()}var h=r.count%25*n,l=function(){var t=r.progress;r.progress=h,s.beginFill(16236829);var e=function(){return t++>=h?(s.endFill(),egret.stopTick(e,null)):(s.drawRoundRect(0,0,t,30,8),!0)};egret.startTick(e,null)};l()},t}();__reflect(TetStrategy.prototype,"TetStrategy");